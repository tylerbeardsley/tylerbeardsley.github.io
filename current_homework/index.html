<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script type = "text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAi1XWg6204cWkmi1cHnD9cqzFd1llj1T0">
    </script>
    <script type="text/javascript">

        var myLat = 0.0;
        var myLng = 0.0;
        var xhr = new XMLHttpRequest();
        var me = new google.maps.LatLng(myLat, myLng);
        var myOptions = {
                zoom: 13,
                center: me,
                mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map;
        var marker;
        var myImage = "41oIHuQ21ML._SS36_.jpg";
        var carmen = "carmen.png";
        var batman = "batman.png";
        var nr = "Norman_Ramsey.png";
        var hescott = "hescott.png";
        var snape = "snape.png";
        var waldo = "waldo.png";
        var infowindow = new google.maps.InfoWindow();
        var places;
        var data;
        var parsed;
        var distancesChart = "<h3>How Far Away Are They?</h3>";
        
        function init()
        {
                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                getMyLocation();
        }
        
        function getMyLocation()
        {
                if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                                myLat = position.coords.latitude;
                                myLng = position.coords.longitude;
                                renderMap();});
                }
                else {
                        alert("Geolocation is not supported by your web browser.");
                }
        }
        function renderMap()
        {
                me = new google.maps.LatLng(myLat, myLng);
                // Update map and go there...
                map.panTo(me);
                // Create a marker
                marker = new google.maps.Marker({
                map: map,
                position: me,
                title: "WendyTestaburger",
                icon: myImage
                });
                marker.setMap(map);
                // Open info window on click of marker
                google.maps.event.addListener(marker, 'click', function() {
                        infowindow.close();
                        infowindow.setContent("<p> Login: " + title + "</p> <p> Lat: " + myLat + "</p> <p> Lng: " + myLng + "</p>");
                        infowindow.open(map, this);
                });

                // Send info to herokuapp
                xhr.open("post", "http://chickenofthesea.herokuapp.com/sendLocation", true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function() {
                     if (xhr.readyState == 4 && xhr.status == 200){
                           data = xhr.responseText;
                           parsed = JSON.parse(data);
                           //check characters
                           for (i = 0; i < parsed["characters"].length; i++){
                              checkCharacter(parsed["characters"][i]);
                              // Draw polylines to characters
                              var flightPathCoords = [me, new google.maps.LatLng(parsed["characters"][i]["loc"]["latitude"], parsed["characters"][i]["loc"]["longitude"])];
                              var flightPath = new google.maps.Polyline({
                                 path: flightPathCoords,
                                 geodesic: true,
                                 strokeColor: "#FF0000",
                                 strokeOpacity: 1.0,
                                 strokeWeight: 2
                              });
                              flightPath.setMap(map);
                              // Call calculateHaversineDistance with character lat and lng and my lat and lng
                              distance = calculateHaversineDistance(parsed["characters"][i]["loc"]["latitude"], parsed["characters"][i]["loc"]["longitude"], myLat, myLng);
                              distance = distance * 0.621371; // convert to miles
                              distancesChart = distancesChart + "<p> Name: " + parsed["characters"][i]["name"] + "</p><p> Distance to Me: " + distance + " miles </p><p></p>";
                           }
                           // print out distances
                           document.getElementById("distancesChart").innerHTML = distancesChart;
                           // check students 
                           for (i = 0; i < parsed["students"].length; i++){
                              createStudentMarker(parsed["students"][i]);
                           }
                     }
                };
                xhr.send("login=WendyTestaburger&lat="+myLat+"&lng="+myLng);

        }
        
        function checkCharacter(character)
        {
                if (character["name"] == "carmen"){
                   createMarker(character, carmen);
                }
                if (character["name"] == "waldo"){
                   createMarker(character, waldo);
                }
                if (character["name"] == "batman"){
                   createMarker(character, batman);
                }
                if (character["name"] == "nr"){
                   createMarker(character, nr);
                }
                if (character["name"] == "snape"){
                   createMarker(character, snape);
                }
                if (character["name"] == "hescott"){
                   createMarker(character, hescott);
                }
        }

        function createMarker(character, image)
        {
                var loc = new google.maps.LatLng(character["loc"]["latitude"], character["loc"]["longitude"]);
                var newMarker = new google.maps.Marker({
                        map: map,
                        position: loc,
                        icon: image
                });
                google.maps.event.addListener(newMarker, 'click', function() {
                        infowindow.close();
                        infowindow.setContent("Name: " + character["name"] + "<p> Lat: " + character["loc"]["latitude"] + "</p> <p> Lng: " + character["loc"]["longitude"] + "</p> <p> Note: " + character["loc"]["note"] + "</p>");
                        infowindow.open(map, this);
                        });
        }
       
        function createStudentMarker(character)
        {
                var loc = new google.maps.LatLng(character["lat"], character["lng"]);
                var newMarker = new google.maps.Marker({
                        map: map,
                        position: loc,
                });
                google.maps.event.addListener(newMarker, 'click', function() {
                        infowindow.close();
                        infowindow.setContent("Login: " + character["login"] + "<p> Lat: " + character["lat"] + "</p> <p> Lng: " + character["lng"] + "</p> <p> Timestamp: " + character["created_at"] + "</p>");
                        infowindow.open(map, this);
                        });
        }

        function toRadians() 
        {
           return this * Math.PI / 180;
        }

        function calculateHaversineDistance(latOne, lngOne, latTwo, lngTwo)
        {
           var R = 6371; //km
           var radOne = latOne * Math.PI / 180;
           var radTwo = latTwo * Math.PI / 180;
           var latRad = (latTwo - latOne) * Math.PI / 180;
           var lngRad = (lngTwo - lngOne) * Math.PI / 180;

           var a = Math.sin(latRad/2) * Math.sin(latRad/2) + Math.cos(radOne) * Math.cos(radTwo) * Math.sin(lngRad/2) * Math.sin(lngRad/2);
           var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
           var d = R * c; 
           return d; 
        }
        </script>
      </head>
   <body onload="init()">
      <div id="map_canvas"></div>
      <div id="distancesChart"></div>
   </body>
</html>
